library('caret')
#update.packages('caret')


                    
                    dataset <- read.csv("C:\\Users\\Admin\\Documents\\Downloads\\ClaMP_Integrated-5184.csv",header=T)
                    dim(dataset)
                    #[1] 5210   70
                    
                    ########CHECK MISSING VALUES
                    missing <- sapply(dataset, function(x) sum(is.na(x)))
                    missing
                    #no missing
                    
                    
                    
                    
                    nzv_dataset <- nearZeroVar(dataset, saveMetrics= TRUE)
                    
                    
                    #######ZERO VARIANCE PREDICTORS
                    #In some situations, the data generating mechanism can create 
                    #predictors that only have a single unique value (i.e. a 
                    #zero-variance predictor). For many models (excluding tree-based models), 
                    #this may cause the model to crash or the fit to be unstable.
                   
                     # freqRatio percentUnique zeroVar   nzv
                    # e_cblp                        13.947826    0.19193858   FALSE FALSE
                    # e_cp                          13.861671    0.15355086   FALSE FALSE
                    # e_cparhdr                    143.611111    0.07677543   FALSE  TRUE
                    # e_maxalloc                   184.892857    0.07677543   FALSE  TRUE
                    # e_sp                         142.972222    0.19193858   FALSE  TRUE
                    # e_lfanew                       1.306709    0.78694818   FALSE FALSE
                    # NumberOfSections               1.291120    0.42226488   FALSE FALSE
                    # CreationYear                 103.200000    0.03838772   FALSE  TRUE
                    # FH_char0                       1.756614    0.03838772   FALSE FALSE
                    # FH_char1                       0.000000    0.01919386    TRUE  TRUE
                    # FH_char2                       1.112733    0.03838772   FALSE FALSE
                    # FH_char3                       1.111877    0.03838772   FALSE FALSE
                    # FH_char4                    5209.000000    0.03838772   FALSE  TRUE
                    # FH_char5                      46.798165    0.03838772   FALSE  TRUE
                    # FH_char6                      15.435331    0.03838772   FALSE FALSE
                    # FH_char7                     346.333333    0.03838772   FALSE  TRUE
                    # FH_char8                      53.270833    0.03838772   FALSE  TRUE
                    # FH_char9                      93.727273    0.03838772   FALSE  TRUE
                    # FH_char10                     93.727273    0.03838772   FALSE  TRUE
                    # FH_char11                      0.000000    0.01919386    TRUE  TRUE
                    # FH_char12                      2.595583    0.03838772   FALSE FALSE
                    # FH_char13                      0.000000    0.01919386    TRUE  TRUE
                    # FH_char14                     15.435331    0.03838772   FALSE FALSE
                    # MajorLinkerVersion             1.278618    0.46065259   FALSE FALSE
                    # MinorLinkerVersion             3.219713    0.71017274   FALSE FALSE
                    # SizeOfCode                     2.909836   18.00383877   FALSE FALSE
                    # SizeOfInitializedData          1.320755   17.92706334   FALSE FALSE
                    # SizeOfUninitializedData       78.847458    3.78119002   FALSE  TRUE
                    # AddressOfEntryPoint            2.863158   67.08253359   FALSE FALSE
                    # BaseOfCode                    17.492366    2.41842610   FALSE FALSE
                    # BaseOfData                     1.120000    7.44721689   FALSE FALSE
                    # ImageBase                      6.572674    0.03838772   FALSE FALSE
                    # SectionAlignment               0.000000    0.01919386    TRUE  TRUE
                    # FileAlignment                  0.000000    0.01919386    TRUE  TRUE
                    # MajorOperatingSystemVersion    2.049311    0.19193858   FALSE FALSE
                    # MinorOperatingSystemVersion    5.981481    0.19193858   FALSE FALSE
                    # MajorImageVersion              4.156532    0.78694818   FALSE FALSE
                    # MinorImageVersion              6.243865    1.05566219   FALSE FALSE
                    # MajorSubsystemVersion          1.814791    0.09596929   FALSE FALSE
                    # MinorSubsystemVersion          5.955423    0.09596929   FALSE FALSE
                    # SizeOfImage                   49.096154    0.03838772   FALSE  TRUE
                    # SizeOfHeaders                216.083333    0.03838772   FALSE  TRUE
                    # CheckSum                     103.055556   62.59117083   FALSE FALSE
                    # Subsystem                      6.504335    0.09596929   FALSE FALSE
                    # OH_DLLchar0                    2.052138    0.03838772   FALSE FALSE
                    # OH_DLLchar1                  136.105263    0.03838772   FALSE  TRUE
                    # OH_DLLchar2                    2.427632    0.03838772   FALSE FALSE
                    # OH_DLLchar3                 5209.000000    0.03838772   FALSE  TRUE
                    # OH_DLLchar4                    5.030093    0.03838772   FALSE FALSE
                    # OH_DLLchar5                    0.000000    0.01919386    TRUE  TRUE
                    # OH_DLLchar6                    0.000000    0.01919386    TRUE  TRUE
                    # OH_DLLchar7                    2.575841    0.03838772   FALSE FALSE
                    # OH_DLLchar8                  399.769231    0.03838772   FALSE  TRUE
                    # OH_DLLchar9                 5209.000000    0.03838772   FALSE  TRUE
                    # OH_DLLchar10                   0.000000    0.01919386    TRUE  TRUE
                    # SizeOfStackReserve             4.430233    0.63339731   FALSE FALSE
                    # SizeOfStackCommit              5.478198    0.42226488   FALSE FALSE
                    # SizeOfHeapReserve             66.056338    0.84452975   FALSE  TRUE
                    # SizeOfHeapCommit              54.033708    0.26871401   FALSE  TRUE
                    # LoaderFlags                 1041.000000    0.03838772   FALSE  TRUE
                    # sus_sections                   2.213058    0.44145873   FALSE FALSE
                    # non_sus_sections               1.888383    0.17274472   FALSE FALSE
                    # packer                         5.392638    0.03838772   FALSE FALSE
                    # packer_type                   19.025974    0.76775432   FALSE  TRUE
                    # E_text                        28.666667   71.11324376   FALSE FALSE
                    # E_data                        16.646465   56.75623800   FALSE FALSE
                    # filesize                       1.020833   45.93090211   FALSE FALSE
                    # E_file                         1.333333   99.65451056   FALSE FALSE
                    # fileinfo                       1.193684    0.03838772   FALSE FALSE
                    # class                          1.094051    0.03838772   FALSE FALSE
                    # 
                   
                    
              
                
                    ######CENTER AND SCALE DATASET
                    
                    preprocessParams <- preProcess(dataset[,-70], method=c("center", "scale"))
                    transformed <- predict(preprocessParams, dataset[,-70])
                    
                    
                    newdataset <- cbind(transformed,dataset[,70])
                    
                    
                    #########DESCRIPTIVE STATS
                    
                    summary(dataset)
                    # 
                    # e_cblp             e_cp            e_cparhdr           e_maxalloc   
                    # Min.   :    0.0   Min.   :    0.00   Min.   :    0.000   Min.   :    0  
                    # 1st Qu.:  144.0   1st Qu.:    3.00   1st Qu.:    4.000   1st Qu.:65535  
                    # Median :  144.0   Median :    3.00   Median :    4.000   Median :65535  
                    # Mean   :  152.7   Mean   :   10.63   Mean   :    8.903   Mean   :65138  
                    # 3rd Qu.:  144.0   3rd Qu.:    3.00   3rd Qu.:    4.000   3rd Qu.:65535  
                    # Max.   :37008.0   Max.   :20050.00   Max.   :12851.000   Max.   :65535  
                    # 
                    # e_sp            e_lfanew     NumberOfSections  CreationYear   
                    # Min.   :    0.0   Min.   : 12.0   Min.   : 1.000   Min.   :0.0000  
                    # 1st Qu.:  184.0   1st Qu.:208.0   1st Qu.: 4.000   1st Qu.:1.0000  
                    # Median :  184.0   Median :232.0   Median : 5.000   Median :1.0000  
                    # Mean   :  202.5   Mean   :222.8   Mean   : 4.663   Mean   :0.9904  
                    # 3rd Qu.:  184.0   3rd Qu.:248.0   3rd Qu.: 5.000   3rd Qu.:1.0000  
                    # Max.   :65534.0   Max.   :648.0   Max.   :34.000   Max.   :1.0000  
                    # 
                    # FH_char0         FH_char1    FH_char2         FH_char3     
                    # Min.   :0.0000   Min.   :1   Min.   :0.0000   Min.   :0.0000  
                    # 1st Qu.:0.0000   1st Qu.:1   1st Qu.:0.0000   1st Qu.:0.0000  
                    # Median :0.0000   Median :1   Median :0.0000   Median :0.0000  
                    # Mean   :0.3628   Mean   :1   Mean   :0.4733   Mean   :0.4735  
                    # 3rd Qu.:1.0000   3rd Qu.:1   3rd Qu.:1.0000   3rd Qu.:1.0000  
                    # Max.   :1.0000   Max.   :1   Max.   :1.0000   Max.   :1.0000  
                    # 
                    # FH_char4            FH_char5          FH_char6          FH_char7     
                    # Min.   :0.0000000   Min.   :0.00000   Min.   :0.00000   Min.   :0.0000  
                    # 1st Qu.:0.0000000   1st Qu.:0.00000   1st Qu.:0.00000   1st Qu.:1.0000  
                    # Median :0.0000000   Median :0.00000   Median :0.00000   Median :1.0000  
                    # Mean   :0.0001919   Mean   :0.02092   Mean   :0.06084   Mean   :0.9971  
                    # 3rd Qu.:0.0000000   3rd Qu.:0.00000   3rd Qu.:0.00000   3rd Qu.:1.0000  
                    # Max.   :1.0000000   Max.   :1.00000   Max.   :1.00000   Max.   :1.0000  
                    # 
                    # FH_char8          FH_char9         FH_char10         FH_char11
                    # Min.   :0.00000   Min.   :0.00000   Min.   :0.00000   Min.   :0  
                    # 1st Qu.:0.00000   1st Qu.:0.00000   1st Qu.:0.00000   1st Qu.:0  
                    # Median :0.00000   Median :0.00000   Median :0.00000   Median :0  
                    # Mean   :0.01843   Mean   :0.01056   Mean   :0.01056   Mean   :0  
                    # 3rd Qu.:0.00000   3rd Qu.:0.00000   3rd Qu.:0.00000   3rd Qu.:0  
                    # Max.   :1.00000   Max.   :1.00000   Max.   :1.00000   Max.   :0  
                    # 
                    # FH_char12        FH_char13   FH_char14       MajorLinkerVersion
                    # Min.   :0.0000   Min.   :0   Min.   :0.00000   Min.   :  0.000   
                    # 1st Qu.:0.0000   1st Qu.:0   1st Qu.:0.00000   1st Qu.:  6.000   
                    # Median :0.0000   Median :0   Median :0.00000   Median :  8.000   
                    # Mean   :0.2781   Mean   :0   Mean   :0.06084   Mean   :  7.604   
                    # 3rd Qu.:1.0000   3rd Qu.:0   3rd Qu.:0.00000   3rd Qu.:  9.000   
                    # Max.   :1.0000   Max.   :0   Max.   :1.00000   Max.   :255.000   
                    # 
                    # MinorLinkerVersion   SizeOfCode        SizeOfInitializedData
                    # Min.   :  0.000    Min.   :0.000e+00   Min.   :0.000e+00    
                    # 1st Qu.:  0.000    1st Qu.:1.178e+04   1st Qu.:1.280e+04    
                    # Median :  0.000    Median :3.738e+04   Median :5.734e+04    
                    # Mean   :  5.438    Mean   :1.548e+06   Mean   :1.013e+06    
                    # 3rd Qu.: 10.000    3rd Qu.:1.352e+05   3rd Qu.:1.029e+05    
                    # Max.   :255.000    Max.   :3.591e+09   Max.   :1.919e+09    
                    # 
                    # SizeOfUninitializedData AddressOfEntryPoint   BaseOfCode      
                    # Min.   :        0       Min.   :       0    Min.   :       0  
                    # 1st Qu.:        0       1st Qu.:    7040    1st Qu.:    4096  
                    # Median :        0       Median :   19006    Median :    4096  
                    # Mean   :   263541       Mean   :  157821    Mean   :   46698  
                    # 3rd Qu.:        0       3rd Qu.:   74520    3rd Qu.:    4096  
                    # Max.   :522125312       Max.   :42403872    Max.   :42225664  
                    # 
                    # BaseOfData         ImageBase      SectionAlignment FileAlignment
                    # Min.   :       0   Min.   :0.0000   Min.   :1        Min.   :1    
                    # 1st Qu.:   16384   1st Qu.:1.0000   1st Qu.:1        1st Qu.:1    
                    # Median :   45056   Median :1.0000   Median :1        Median :1    
                    # Mean   :  226829   Mean   :0.8679   Mean   :1        Mean   :1    
                    # 3rd Qu.:  159744   3rd Qu.:1.0000   3rd Qu.:1        3rd Qu.:1    
                    # Max.   :42405888   Max.   :1.0000   Max.   :1        Max.   :1    
                    # 
                    # MajorOperatingSystemVersion MinorOperatingSystemVersion MajorImageVersion
                    # Min.   : 0.000              Min.   : 0.0000             Min.   :    0.0  
                    # 1st Qu.: 4.000              1st Qu.: 0.0000             1st Qu.:    0.0  
                    # Median : 4.000              Median : 0.0000             Median :    0.0  
                    # Mean   : 4.613              Mean   : 0.4136             Mean   :  107.1  
                    # 3rd Qu.: 5.000              3rd Qu.: 1.0000             3rd Qu.:    4.0  
                    # Max.   :10.000              Max.   :23.0000             Max.   :40386.0  
                    # 
                    # MinorImageVersion  MajorSubsystemVersion MinorSubsystemVersion  SizeOfImage  
                    # Min.   :    0.00   Min.   :1.000         Min.   : 0.0000       Min.   :0.00  
                    # 1st Qu.:    0.00   1st Qu.:4.000         1st Qu.: 0.0000       1st Qu.:1.00  
                    # Median :    0.00   Median :4.000         Median : 0.0000       Median :1.00  
                    # Mean   :   97.84   Mean   :4.589         Mean   : 0.3541       Mean   :0.98  
                    # 3rd Qu.:    0.00   3rd Qu.:5.000         3rd Qu.: 0.0000       3rd Qu.:1.00  
                    # Max.   :51126.00   Max.   :6.000         Max.   :20.0000       Max.   :1.00  
                    # 
                    # SizeOfHeaders       CheckSum           Subsystem       OH_DLLchar0    
                    # Min.   :0.0000   Min.   :0.000e+00   Min.   : 1.000   Min.   :0.0000  
                    # 1st Qu.:1.0000   1st Qu.:0.000e+00   1st Qu.: 2.000   1st Qu.:0.0000  
                    # Median :1.0000   Median :7.747e+04   Median : 2.000   Median :0.0000  
                    # Mean   :0.9954   Mean   :2.310e+06   Mean   : 2.143   Mean   :0.3276  
                    # 3rd Qu.:1.0000   3rd Qu.:2.071e+05   3rd Qu.: 2.000   3rd Qu.:1.0000  
                    # Max.   :1.0000   Max.   :4.295e+09   Max.   :16.000   Max.   :1.0000  
                    # 
                    # OH_DLLchar1        OH_DLLchar2      OH_DLLchar3         OH_DLLchar4    
                    # Min.   :0.000000   Min.   :0.0000   Min.   :0.0000000   Min.   :0.0000  
                    # 1st Qu.:0.000000   1st Qu.:0.0000   1st Qu.:0.0000000   1st Qu.:0.0000  
                    # Median :0.000000   Median :0.0000   Median :0.0000000   Median :0.0000  
                    # Mean   :0.007294   Mean   :0.2917   Mean   :0.0001919   Mean   :0.1658  
                    # 3rd Qu.:0.000000   3rd Qu.:1.0000   3rd Qu.:0.0000000   3rd Qu.:0.0000  
                    # Max.   :1.000000   Max.   :1.0000   Max.   :1.0000000   Max.   :1.0000  
                    # 
                    # OH_DLLchar5  OH_DLLchar6  OH_DLLchar7      OH_DLLchar8      
                    # Min.   :0    Min.   :0    Min.   :0.0000   Min.   :0.000000  
                    # 1st Qu.:0    1st Qu.:0    1st Qu.:0.0000   1st Qu.:0.000000  
                    # Median :0    Median :0    Median :0.0000   Median :0.000000  
                    # Mean   :0    Mean   :0    Mean   :0.2797   Mean   :0.002495  
                    # 3rd Qu.:0    3rd Qu.:0    3rd Qu.:1.0000   3rd Qu.:0.000000  
                    # Max.   :0    Max.   :0    Max.   :1.0000   Max.   :1.000000  
                    # 
                    # OH_DLLchar9         OH_DLLchar10 SizeOfStackReserve SizeOfStackCommit
                    # Min.   :0.0000000   Min.   :0     Min.   :       0   Min.   :      0  
                    # 1st Qu.:0.0000000   1st Qu.:0     1st Qu.: 1048576   1st Qu.:   4096  
                    # Median :0.0000000   Median :0     Median : 1048576   Median :   4096  
                    # Mean   :0.0001919   Mean   :0     Mean   : 1987331   Mean   :  10376  
                    # 3rd Qu.:0.0000000   3rd Qu.:0     3rd Qu.: 1048576   3rd Qu.:   8192  
                    # Max.   :1.0000000   Max.   :0     Max.   :33554432   Max.   :2097152  
                    # 
                    # SizeOfHeapReserve  SizeOfHeapCommit  LoaderFlags     sus_sections   
                    # Min.   :       0   Min.   :     0   Min.   :0.000   Min.   : 0.000  
                    # 1st Qu.: 1048576   1st Qu.:  4096   1st Qu.:1.000   1st Qu.: 1.000  
                    # Median : 1048576   Median :  4096   Median :1.000   Median : 1.000  
                    # Mean   : 2087040   Mean   :  5751   Mean   :0.999   Mean   : 1.361  
                    # 3rd Qu.: 1048576   3rd Qu.:  4096   3rd Qu.:1.000   3rd Qu.: 2.000  
                    # Max.   :33554432   Max.   :131072   Max.   :1.000   Max.   :31.000  
                    # 
                    # non_sus_sections     packer                         packer_type  
                    # Min.   :0.000    Min.   :0.0000   NoPacker                :4395  
                    # 1st Qu.:3.000    1st Qu.:0.0000   UPXv20MarkusLaszloReiser: 231  
                    # Median :4.000    Median :0.0000   Armadillov171           : 154  
                    # Mean   :3.302    Mean   :0.1564   Armadillov1xxv2xx       : 110  
                    # 3rd Qu.:4.000    3rd Qu.:0.0000   NETDLLMicrosoft         :  93  
                    # Max.   :8.000    Max.   :1.0000   NETexecutableMicrosoft  :  90  
                    # (Other)                 : 137  
                    # E_text          E_data         filesize             E_file      
                    # Min.   :0.000   Min.   :0.000   Min.   :     1536   Min.   :0.9396  
                    # 1st Qu.:3.886   1st Qu.:0.000   1st Qu.:    61440   1st Qu.:5.6958  
                    # Median :6.148   Median :1.556   Median :   121856   Median :6.3906  
                    # Mean   :4.940   Mean   :2.524   Mean   :   787572   Mean   :6.3648  
                    # 3rd Qu.:6.507   3rd Qu.:4.686   3rd Qu.:   305548   3rd Qu.:7.3145  
                    # Max.   :8.000   Max.   :8.000   Max.   :165708080   Max.   :8.0000  
                    # 
                    # fileinfo          class       
                    # Min.   :0.0000   Min.   :0.0000  
                    # 1st Qu.:0.0000   1st Qu.:0.0000  
                    # Median :1.0000   Median :1.0000  
                    # Mean   :0.5441   Mean   :0.5225  
                    # 3rd Qu.:1.0000   3rd Qu.:1.0000  
                    # Max.   :1.0000   Max.   :1.0000 
                    
                    
                   df1 <- dataset[,1:7] 
                   df2 <- dataset[,8:14]
                   df3 <- dataset[,15:21]
                   df4 <- dataset[,22:28]
                   df5 <- dataset[,29:35]
                   df6 <- dataset[,36:42]
                   df7 <- dataset[,43:49]
                   df8 <- dataset[,50:56]
                   df9 <- dataset[,57:63]
                   df10 <- dataset[,64:70]
               
               
                    pdf("D:\\ASHOKPATADE\\dataset10.pdf")
                    ggplot(melt(df10), aes(variable, value)) + geom_boxplot()
                    dev.off()
                  
                    
                    
                    #########TRAIN AND TEST SPLIT
                    
                    
                    trainIndex <- createDataPartition(dataset$class, p = .8, 
                    list = FALSE, 
                    times = 1)
                    
                    
                    malTrain <- dataset[ trainIndex,]
                    malTest  <- dataset[-trainIndex,]
                    
                    
                    
                    ########Parameter Tuning
                    
                    
                    malTrain[,'class']<-factor(malTrain[,'class'])
                    
                    
                    fitControl_1 <- trainControl(method = "boot", number = 3,
                    repeats = 3, p = 0.75,
                    search = "random", classProbs = FALSE,
                    summaryFunction = defaultSummary,
                    allowParallel = TRUE)
                    
                    
                    set.seed(825)
                    
                    drops <- c("e_res","e_res2")
                    malTrain <- malTrain[ , !(names(malTrain) %in% drops)]
                    malTest <- malTest[ , !(names(malTest) %in% drops)]
                    
                    
                    gbmFit1 <- train(class ~ ., data = malTrain, 
                    method = "gbm", 
                    trControl = fitControl_1,
                    ## This last option is actually one
                    ## for gbm() that passes through
                    verbose = FALSE)
                    # 
                    # 
                    # ######DESCRIPTION OF MODEL - Gradient boosted trees
                 
                    # Stochastic Gradient Boosting 
                    # 
                    # 4168 samples
                    # 69 predictor
                    # 2 classes: '0', '1' 
                    # 
                    # No pre-processing
                    # Resampling: Bootstrapped (3 reps) 
                    # Summary of sample sizes: 4168, 4168, 4168 
                    # Resampling results across tuning parameters:
                    #   
                    #   shrinkage  interaction.depth  n.minobsinnode  n.trees  Accuracy   Kappa    
                    # 0.3927204  9                  19              2918     0.9796311  0.9591888
                    # 0.5499182  1                  16              2003     0.9870794  0.9741344
                    # 0.5790771  1                   7              3057     0.9846764  0.9693236
                    # 
                    # Accuracy was used to select the optimal model using  the largest value.
                    # The final values used for the model were n.trees = 2003, interaction.depth
                    # = 1, shrinkage = 0.5499182 and n.minobsinnode = 16. 
                    # 
                    
                    
                    mal_pred_gbm1 <- predict.train(gbmFit1, newdata=malTest, models=gbmFit1$finalModel)
                    
                    head(mal_pred_gbm1)
                    
                    ##########RESULTS
                    
                    gbm1cm <- confusionMatrix(data = mal_pred_gbm1, reference = malTest$class)
                    
   #                  Confusion Matrix and Statistics
   #                  
   #                  Reference
   #                  Prediction   0   1
   #                  0 500   7
   #                  1   7 528
   #                  
   #                  Accuracy : 0.9866          
   #                  95% CI : (0.9776, 0.9926)
   #                  No Information Rate : 0.5134          
   #                  P-Value [Acc > NIR] : <2e-16          
   #                  
   #                  Kappa : 0.9731          
   #                  Mcnemar's Test P-Value : 1               
   #                                        
   #          Sensitivity : 0.9862          
   #          Specificity : 0.9869          
   #       Pos Pred Value : 0.9862          
   #       Neg Pred Value : 0.9869          
   #           Prevalence : 0.4866          
   #       Detection Rate : 0.4798          
   # Detection Prevalence : 0.4866          
   #    Balanced Accuracy : 0.9866          
   #                                        
   #     'Positive' Class : 0
                  
                    
                    gbm2cm <- confusionMatrix(data = mal_pred_gbm1, reference = malTest$class, mode = "prec_recall")
                    # 
                    # 
                    # Confusion Matrix and Statistics
                 
   #                  Confusion Matrix and Statistics
   #                  
   #                  Reference
   #                  Prediction   0   1
   #                  0 500   7
   #                  1   7 528
   #                  
   #                  Accuracy : 0.9866          
   #                  95% CI : (0.9776, 0.9926)
   #                  No Information Rate : 0.5134          
   #                  P-Value [Acc > NIR] : <2e-16          
   #                  
   #                  Kappa : 0.9731          
   #                  Mcnemar's Test P-Value : 1               
   #                                        
   #            Precision : 0.9862          
   #               Recall : 0.9862          
   #                   F1 : 0.9862          
   #           Prevalence : 0.4866          
   #       Detection Rate : 0.4798          
   # Detection Prevalence : 0.4866          
   #    Balanced Accuracy : 0.9866          
   #                                        
   #     'Positive' Class : 0 
                    
                    
                    ################SECOND PREDICTION ALGO
                    
                    
                    
                    fitControl_2 <- trainControl(method = "boot", number = 3,
                    repeats = 3, p = 0.75,
                    search = "random", classProbs = FALSE,
                    summaryFunction = defaultSummary,
                    allowParallel = TRUE)
                    
                    
                    rfFit1 <- train(class ~ ., data = malTrain, 
                    method = "rf", 
                    trControl = fitControl_2,
                    ## This last option is actually one
                    ## for gbm() that passes through
                    verbose = FALSE)
                    
                    # ########RANDOM FOREST
                    # 
                    # Random Forest 
                    # 
                    # 4168 samples
                    # 69 predictor
                    # 2 classes: '0', '1' 
                    # 
                    # No pre-processing
                    # Resampling: Bootstrapped (3 reps) 
                    # Summary of sample sizes: 4168, 4168, 4168 
                    # Resampling results across tuning parameters:
                    #   
                    #   mtry  Accuracy   Kappa    
                    # 14    0.9897721  0.9794357
                    # 41    0.9895376  0.9789401
                    # 87    0.9853896  0.9705935
                    # 
                    # Accuracy was used to select the optimal model using  the largest value.
                    # The final value used for the model was mtry = 14. 
                    # 
                    #########PREDICTING
                    
                    mal_pred_rf1 <- predict.train(rfFit1, newdata=malTest, models=rfFit1$finalModel)
                    
                    #####ACCURACY
                    
                    
                    rf1cm <- confusionMatrix(data = mal_pred_rf1, reference = malTest$class)
                    
                    # # Confusion Matrix and Statistics
                    # 
                    # Confusion Matrix and Statistics
                    # 
                    # Reference
                    # Prediction   0   1
                    # 0 506   2
                    # 1   1 533
                    # 
                    # Accuracy : 0.9971          
                    # 95% CI : (0.9916, 0.9994)
                    # No Information Rate : 0.5134          
                    # P-Value [Acc > NIR] : <2e-16          
                    # 
                    # Kappa : 0.9942          
                    # Mcnemar's Test P-Value : 1               
                    # 
                    # Sensitivity : 0.9980          
                    # Specificity : 0.9963          
                    # Pos Pred Value : 0.9961          
                    # Neg Pred Value : 0.9981          
                    # Prevalence : 0.4866          
                    # Detection Rate : 0.4856          
                    # Detection Prevalence : 0.4875          
                    # Balanced Accuracy : 0.9971          
                    # 
                    # 'Positive' Class : 0

                    rf2cm <- confusionMatrix(data = mal_pred_rf1, reference = malTest$class, mode = "prec_recall")
                    # 
                    # 
                    # Confusion Matrix and Statistics
                 
   #                  Confusion Matrix and Statistics
   #                  
   #                  Reference
   #                  Prediction   0   1
   #                  0 506   2
   #                  1   1 533
   #                  
   #                  Accuracy : 0.9971          
   #                  95% CI : (0.9916, 0.9994)
   #                  No Information Rate : 0.5134          
   #                  P-Value [Acc > NIR] : <2e-16          
   #                  
   #                  Kappa : 0.9942          
   #                  Mcnemar's Test P-Value : 1               
   #                                        
   #            Precision : 0.9961          
   #               Recall : 0.9980          
   #                   F1 : 0.9970          
   #           Prevalence : 0.4866          
   #       Detection Rate : 0.4856          
   # Detection Prevalence : 0.4875          
   #    Balanced Accuracy : 0.9971          
   #                                        
   #     'Positive' Class : 0
                    
                    ########THIRD CLASSIFIER - EXTREME LEARNING MACHINE
                    
                    
                    fitControl_3 <- trainControl(method = "boot", number = 3,
                    repeats = 3, p = 0.75,
                    search = "random", classProbs = FALSE,
                    summaryFunction = defaultSummary,
                    allowParallel = TRUE)
                    
                    
                    elmFit1 <- train(class ~ ., data = malTrain, 
                    method = "elm", 
                    trControl = fitControl_3,
                    ## This last option is actually one
                    ## for gbm() that passes through
                    verbose = FALSE)
                    
                    # Extreme Learning Machine 
                 
                    # Extreme Learning Machine 
                    # 
                    # 4168 samples
                    # 69 predictor
                    # 2 classes: '0', '1' 
                    # 
                    # No pre-processing
                    # Resampling: Bootstrapped (3 reps) 
                    # Summary of sample sizes: 4168, 4168, 4168 
                    # Resampling results across tuning parameters:
                    #   
                    #   nhid  Accuracy   Kappa    
                    # 6    0.5723350  0.1077076
                    # 14    0.6930593  0.3755951
                    # 15    0.6975302  0.3850519
                    # 
                    # Tuning parameter 'actfun' was held constant at a value of purelin
                    # Accuracy was used to select the optimal model using  the largest value.
                    # The final values used for the model were nhid = 15 and actfun = purelin.
                    # 
                    mal_pred_elm1 <- predict.train(elmFit1, newdata=malTest, models=elmFit1$finalModel)
                    
                    
                    
                    elm1cm <-  confusionMatrix(data = mal_pred_elm1, reference = malTest$class)
                    # Confusion Matrix and Statistics
                  
                    # Confusion Matrix and Statistics
                    # 
                    # Reference
                    # Prediction   0   1
                    # 0 343  74
                    # 1 164 461
                    # 
                    # Accuracy : 0.7716          
                    # 95% CI : (0.7449, 0.7968)
                    # No Information Rate : 0.5134          
                    # P-Value [Acc > NIR] : < 2.2e-16       
                    # 
                    # Kappa : 0.5407          
                    # Mcnemar's Test P-Value : 7.974e-09       
                    # 
                    # Sensitivity : 0.6765          
                    # Specificity : 0.8617          
                    # Pos Pred Value : 0.8225          
                    # Neg Pred Value : 0.7376          
                    # Prevalence : 0.4866          
                    # Detection Rate : 0.3292          
                    # Detection Prevalence : 0.4002          
                    # Balanced Accuracy : 0.7691          
                    # 
                    # 'Positive' Class : 0 
                                                       
                    elm2cm <-  confusionMatrix(data = mal_pred_elm1, reference = malTest$class, mode = "prec_recall")
                    # Confusion Matrix and Statistics
                  
                    # Confusion Matrix and Statistics
                    # 
                    # Reference
                    # Prediction   0   1
                    # 0 343  74
                    # 1 164 461
                    # 
                    # Accuracy : 0.7716          
                    # 95% CI : (0.7449, 0.7968)
                    # No Information Rate : 0.5134          
                    # P-Value [Acc > NIR] : < 2.2e-16       
                    # 
                    # Kappa : 0.5407          
                    # Mcnemar's Test P-Value : 7.974e-09       
                    # 
                    # Precision : 0.8225          
                    # Recall : 0.6765          
                    # F1 : 0.7424          
                    # Prevalence : 0.4866          
                    # Detection Rate : 0.3292          
                    # Detection Prevalence : 0.4002          
                    # Balanced Accuracy : 0.7691          
                    # 
                    # 'Positive' Class : 0 
                    
                    
                    
                    ########### EXTREME GRADIENT BOOSTED TREES
                    
                    fitControl_4 <- trainControl(method = "boot", number = 3,
                    repeats = 3, p = 0.75,
                    search = "random", classProbs = FALSE,
                    summaryFunction = defaultSummary,
                    allowParallel = TRUE)
                    
                    
                    xgbFit1 <- train(class ~ ., data = malTrain, 
                    method = "xgbTree", 
                    trControl = fitControl_4,
                    ## This last option is actually one
                    ## for gbm() that passes through
                    verbose = FALSE)
                    
                    # eXtreme Gradient Boosting 
                    # 
                    # 
                    # eXtreme Gradient Boosting 
                    # 
                    # 4168 samples
                    # 69 predictor
                    # 2 classes: '0', '1' 
                    # 
                    # No pre-processing
                    # Resampling: Bootstrapped (3 reps) 
                    # Summary of sample sizes: 4168, 4168, 4168 
                    # Resampling results across tuning parameters:
                    #   
                    #   eta        max_depth  gamma     colsample_bytree  min_child_weight
                    # 0.0621894  6          6.947912  0.3333700          8              
                    # 0.3483079  9          3.308534  0.4743447          9              
                    # 0.4994430  4          2.375988  0.5290381         12              
                    # subsample  nrounds  Accuracy   Kappa    
                    # 0.3391268  158      0.9674103  0.9347096
                    # 0.8620105  816      0.9836040  0.9671582
                    # 0.5944769  855      0.9794441  0.9588210
                    # 
                    # Accuracy was used to select the optimal model using  the largest value.
                    # The final values used for the model were nrounds = 816, max_depth = 9, eta
                    # = 0.3483079, gamma = 3.308534, colsample_bytree = 0.4743447,
                    # min_child_weight = 9 and subsample = 0.8620105. 
                    
                    mal_pred_xgb1 <- predict.train(xgbFit1, newdata=malTest, models=xgbFit1$finalModel)
                    
                    
                    xgb1cm <- confusionMatrix(data = mal_pred_xgb1, reference = malTest$class)
                    # Confusion Matrix and Statistics
                  
                                                      
                    xgb2cm <- confusionMatrix(data = mal_pred_xgb1, reference = malTest$class, mode = "prec_recall")
                    
                    
                    
                    # Confusion Matrix and Statistics
                    # 
                xgb1cm
                    # Confusion Matrix and Statistics
                    # 
                    # Reference
                    # Prediction   0   1
                    # 0 502   9
                    # 1   5 526
                    # 
                    # Accuracy : 0.9866          
                    # 95% CI : (0.9776, 0.9926)
                    # No Information Rate : 0.5134          
                    # P-Value [Acc > NIR] : <2e-16          
                    # 
                    # Kappa : 0.9731          
                    # Mcnemar's Test P-Value : 0.4227          
                    # 
                    # Sensitivity : 0.9901          
                    # Specificity : 0.9832          
                    # Pos Pred Value : 0.9824          
                    # Neg Pred Value : 0.9906          
                    # Prevalence : 0.4866          
                    # Detection Rate : 0.4818          
                    # Detection Prevalence : 0.4904          
                    # Balanced Accuracy : 0.9867          
                    # 
                    # 'Positive' Class : 0               
                    # 
                     xgb2cm
                    # Confusion Matrix and Statistics
                    # 
                    # Reference
                    # Prediction   0   1
                    # 0 502   9
                    # 1   5 526
                    # 
                    # Accuracy : 0.9866          
                    # 95% CI : (0.9776, 0.9926)
                    # No Information Rate : 0.5134          
                    # P-Value [Acc > NIR] : <2e-16          
                    # 
                    # Kappa : 0.9731          
                    # Mcnemar's Test P-Value : 0.4227          
                    # 
                    # Precision : 0.9824          
                    # Recall : 0.9901          
                    # F1 : 0.9862          
                    # Prevalence : 0.4866          
                    # Detection Rate : 0.4818          
                    # Detection Prevalence : 0.4904          
                    # Balanced Accuracy : 0.9867          
                    # 
                    # 'Positive' Class : 0 
                    # 
                    
                    ####### COMPARE MODELS
                    
                    resamps <- resamples(list(GBM = gbmFit1,
                    RF = rfFit1,
                    ELM = elmFit1, XGB = xgbFit1))
                    
                    
                    summary(resamps)
                    
                    # Call:
                    #   summary.resamples(object = resamps)
                    # 
                    # Models: GBM, RF, ELM, XGB 
                    # Number of resamples: 3 
                    # 
                    # Accuracy 
                    # Min. 1st Qu. Median   Mean 3rd Qu.   Max. NA's
                    # GBM 0.9849  0.9852 0.9855 0.9871  0.9882 0.9909    0
                    # RF  0.9895  0.9896 0.9897 0.9898  0.9899 0.9902    0
                    # ELM 0.6654  0.6717 0.6780 0.6975  0.7136 0.7492    0
                    # XGB 0.9810  0.9817 0.9823 0.9836  0.9849 0.9875    0
                    # 
                    # Kappa 
                    # Min. 1st Qu. Median   Mean 3rd Qu.   Max. NA's
                    # GBM 0.9697  0.9703 0.9709 0.9741  0.9764 0.9818    0
                    # RF  0.9790  0.9791 0.9793 0.9794  0.9797 0.9801    0
                    # ELM 0.3164  0.3298 0.3432 0.3851  0.4194 0.4955    0
                    # XGB 0.9620  0.9633 0.9646 0.9672  0.9697 0.9749    0
                    
                    trellis.par.set(theme1)
                    pdf("D:\\ASHOKPATADE\\resamples.pdf")
                    bwplot(resamps, layout = c(3, 1))
                    dev.off()
                    
                    
                    ##########COMPUTE VARIABLE IMPORTANCE
                    
                    gbmImp <- varImp(gbmFit1, scale = FALSE)
                    
                   
                    xgbImp <- varImp(xgbFit1, scale = FALSE)
                    rfImp <- varImp(rfFit1, scale = FALSE)
                    
                    # ROC curve variable importance
            
                 
                    # 
                    # gbm variable importance
                    # 
                    # only 20 most important variables shown (out of 107)
                    # 
                    # Overall
                    # FH_char12                         216.640
                    # OH_DLLchar2                       132.140
                    # fileinfo                           59.409
                    # E_file                             41.569
                    # CheckSum                           37.537
                    # filesize                           35.072
                    # MajorImageVersion                  16.266
                    # Subsystem                          13.740
                    # packer_typeNETexecutableMicrosoft  11.180
                    # sus_sections                       10.929
                    # E_data                              9.701
                    # e_lfanew                            6.766
                    # AddressOfEntryPoint                 6.728
                    # MinorSubsystemVersion               4.337
                    # MajorOperatingSystemVersion         2.693
                    # non_sus_sections                    2.185
                    # SizeOfStackReserve                  1.662
                    # E_text                              1.639
                    # SizeOfInitializedData               1.446
                    # MinorLinkerVersion                  1.346
                    # > xgbImp
                    # xgbTree variable importance
                    # 
                    # only 20 most important variables shown (out of 36)
                    # 
                    # Overall
                    # FH_char12                         0.193955
                    # SizeOfStackReserve                0.132823
                    # E_file                            0.074706
                    # fileinfo                          0.071739
                    # OH_DLLchar0                       0.067157
                    # CheckSum                          0.061475
                    # filesize                          0.057990
                    # Subsystem                         0.056745
                    # OH_DLLchar2                       0.039784
                    # sus_sections                      0.038410
                    # e_lfanew                          0.032315
                    # E_data                            0.025221
                    # MajorLinkerVersion                0.023191
                    # FH_char0                          0.019649
                    # E_text                            0.017820
                    # MajorSubsystemVersion             0.013477
                    # OH_DLLchar4                       0.010896
                    # AddressOfEntryPoint               0.008938
                    # MajorImageVersion                 0.008214
                    # packer_typeNETexecutableMicrosoft 0.006423
                    # > rfImp
                    # rf variable importance
                    # 
                    # only 20 most important variables shown (out of 107)
                    # 
                    # Overall
                    # FH_char12                    350.50
                    # CheckSum                     162.88
                    # E_file                       146.11
                    # OH_DLLchar2                  122.79
                    # FH_char0                     114.53
                    # fileinfo                     103.49
                    # filesize                      88.31
                    # OH_DLLchar0                   84.97
                    # Subsystem                     68.40
                    # AddressOfEntryPoint           68.23
                    # E_data                        67.17
                    # sus_sections                  52.30
                    # SizeOfStackReserve            46.86
                    # MajorImageVersion             46.16
                    # MajorLinkerVersion            41.80
                    # e_lfanew                      40.60
                    # MajorSubsystemVersion         40.49
                    # E_text                        40.38
                    # MajorOperatingSystemVersion   36.17
                    # SizeOfCode                    32.99                  
                    # 
                    # 
                    
                    
                    
                    
                    
                    
                    
                       
                    
                    #########PLOTS - NOT USED
                    
                    
                    trellis.par.set(caretTheme())
                    pdf("D:\\ASHOKPATADE\\GBMFit-kappa.pdf")
                    plot(gbmFit1, metric = "Kappa", plotType = "level",
                    scales = list(x = list(rot = 90)))
                    dev.off()
                    
                    trellis.par.set(caretTheme())
                    pdf("D:\\ASHOKPATADE\\GBMFit-acc.pdf")
                    plot(gbmFit1, metric = "Accuracy", plotType = "level",
                    scales = list(x = list(rot = 90)))
                    dev.off()
                    
                    
                    trellis.par.set(caretTheme())
                    pdf("D:\\ASHOKPATADE\\GBMFit-prec.pdf")
                    densityplot(gbmFit1, pch = "|")
                    dev.off()
                    
                    
                    ########## PLOT - CONFUSION MATRIX
                    
                    
                    draw_confusion_matrix <- function(cm) {
                    
                    layout(matrix(c(1,1,2)))
                    par(mar=c(2,2,2,2))
                    plot(c(100, 345), c(300, 450), type = "n", xlab="", ylab="", xaxt='n', yaxt='n')
                    title('CONFUSION MATRIX', cex.main=2)
                    
                    # create the matrix 
                    rect(150, 430, 240, 370, col='#3F97D0')
                    text(195, 435, 'Class1', cex=1.2)
                    rect(250, 430, 340, 370, col='#F7AD50')
                    text(295, 435, 'Class2', cex=1.2)
                    text(125, 370, 'Predicted', cex=1.3, srt=90, font=2)
                    text(245, 450, 'Actual', cex=1.3, font=2)
                    rect(150, 305, 240, 365, col='#F7AD50')
                    rect(250, 305, 340, 365, col='#3F97D0')
                    text(140, 400, 'Class1', cex=1.2, srt=90)
                    text(140, 335, 'Class2', cex=1.2, srt=90)
                    
                    # add in the cm results 
                    res <- as.numeric(cm$table)
                    text(195, 400, res[1], cex=1.6, font=2, col='white')
                    text(195, 335, res[2], cex=1.6, font=2, col='white')
                    text(295, 400, res[3], cex=1.6, font=2, col='white')
                    text(295, 335, res[4], cex=1.6, font=2, col='white')
                    
                    # add in the specifics 
                    plot(c(100, 0), c(100, 0), type = "n", xlab="", ylab="", main = "DETAILS", xaxt='n', yaxt='n')
                    text(10, 85, names(cm$byClass[1]), cex=1.2, font=2)
                    text(10, 70, round(as.numeric(cm$byClass[1]), 3), cex=1.2)
                    text(30, 85, names(cm$byClass[2]), cex=1.2, font=2)
                    text(30, 70, round(as.numeric(cm$byClass[2]), 3), cex=1.2)
                    text(50, 85, names(cm$byClass[5]), cex=1.2, font=2)
                    text(50, 70, round(as.numeric(cm$byClass[5]), 3), cex=1.2)
                    text(70, 85, names(cm$byClass[6]), cex=1.2, font=2)
                    text(70, 70, round(as.numeric(cm$byClass[6]), 3), cex=1.2)
                    text(90, 85, names(cm$byClass[7]), cex=1.2, font=2)
                    text(90, 70, round(as.numeric(cm$byClass[7]), 3), cex=1.2)
                    
                    # add in the accuracy information 
                    text(30, 35, names(cm$overall[1]), cex=1.5, font=2)
                    text(30, 20, round(as.numeric(cm$overall[1]), 3), cex=1.4)
                    text(70, 35, names(cm$overall[2]), cex=1.5, font=2)
                    text(70, 20, round(as.numeric(cm$overall[2]), 3), cex=1.4)
                    } 
                    
                    
                    pdf("D:\\ASHOKPATADE\\elm1Fit-confmat.pdf")
                    draw_confusion_matrix(elm1cm)
                    dev.off()
                    
                 
                    
                    pdf("D:\\ASHOKPATADE\\gbm1Fit-confmat.pdf")
                    draw_confusion_matrix(gbm1cm)
                    dev.off()
                    
               
                    pdf("D:\\ASHOKPATADE\\rf1Fit-confmat.pdf")
                    draw_confusion_matrix(rf1cm)
                    dev.off()
                    
             
                    
                    pdf("D:\\ASHOKPATADE\\XGB1Fit-confmat.pdf")
                    draw_confusion_matrix(xgb1cm)
                    dev.off()
                    
                