library('caret')
#update.packages('caret')

dataset <- read.csv("C:\\Users\\Admin\\Documents\\Downloads\\ClaMP_Raw-5184.csv",header=T)
#dim(dataset)
#[1] 5184   56

########CHECK MISSING VALUES
missing <- sapply(dataset, function(x) sum(is.na(x)))

#e_res, e_res2 are blank and so have to be removed




nzv_dataset <- nearZeroVar(dataset, saveMetrics= TRUE)


#######ZERO VARIANCE PREDICTORS
#In some situations, the data generating mechanism can create 
#predictors that only have a single unique value (i.e. a 
#“zero-variance predictor”). For many models (excluding tree-based models), 
#this may cause the model to crash or the fit to be unstable.

#                              freqRatio percentUnique zeroVar   nzv
#e_magic                        0.000000    0.01929012    TRUE  TRUE
#e_cblp                        14.011696    0.17361111   FALSE FALSE
#e_cp                          13.924419    0.13503086   FALSE FALSE
#e_crlc                         0.000000    0.01929012    TRUE  TRUE
#e_cparhdr                    142.972222    0.05787037   FALSE  TRUE
#e_minalloc                    13.720798    0.07716049   FALSE FALSE
#e_maxalloc                   184.035714    0.05787037   FALSE  TRUE
#e_ss                        5183.000000    0.03858025   FALSE  TRUE
#e_sp                         142.333333    0.15432099   FALSE  TRUE
#e_csum                      2590.500000    0.05787037   FALSE  TRUE
#e_ip                        2590.000000    0.07716049   FALSE  TRUE
#e_cs                        2590.000000    0.07716049   FALSE  TRUE
#e_lfarlc                     166.193548    0.05787037   FALSE  TRUE
#e_ovno                        13.853868    0.03858025   FALSE FALSE
#e_res                          0.000000    0.00000000    TRUE  TRUE
#e_oemid                     1727.000000    0.03858025   FALSE  TRUE
#e_oeminfo                   2590.500000    0.05787037   FALSE  TRUE
#e_res2                         0.000000    0.00000000    TRUE  TRUE
#e_lfanew                       1.319936    0.75231481   FALSE FALSE
#Machine                      470.181818    0.05787037   FALSE  TRUE
#NumberOfSections               1.297740    0.42438272   FALSE FALSE
#CreationYear                   1.629841    0.69444444   FALSE FALSE
#PointerToSymbolTable        5176.000000    0.17361111   FALSE  TRUE
#NumberOfSymbols             5172.000000    0.25077160   FALSE  TRUE
#SizeOfOptionalHeader         470.272727    0.03858025   FALSE  TRUE
#Characteristics                1.036928    0.81018519   FALSE FALSE
#Magic                        470.272727    0.03858025   FALSE  TRUE
#MajorLinkerVersion             1.278618    0.44367284   FALSE FALSE
#MinorLinkerVersion             3.241451    0.69444444   FALSE FALSE
#SizeOfCode                     3.050000   18.05555556   FALSE FALSE
#SizeOfInitializedData          1.312500   17.93981481   FALSE FALSE
#SizeOfUninitializedData       78.491525    3.74228395   FALSE  TRUE
#AddressOfEntryPoint            3.688312   67.12962963   FALSE FALSE
#BaseOfCode                    17.292776    2.39197531   FALSE FALSE
#BaseOfData                     1.108571    7.42669753   FALSE FALSE
#ImageBase                      3.993311    7.79320988   FALSE FALSE
#SectionAlignment              18.191011    0.11574074   FALSE FALSE
#FileAlignment                  4.193909    0.13503086   FALSE FALSE
#MajorOperatingSystemVersion    2.027616    0.19290123   FALSE FALSE
#MinorOperatingSystemVersion    5.945988    0.19290123   FALSE FALSE
#MajorImageVersion              4.133858    0.79089506   FALSE FALSE
#MinorImageVersion              6.210123    1.02237654   FALSE FALSE
#MajorSubsystemVersion          1.794304    0.11574074   FALSE FALSE
#MinorSubsystemVersion          5.937407    0.09645062   FALSE FALSE
#SizeOfImage                    1.068571   13.02083333   FALSE FALSE
#SizeOfHeaders                  2.558121    0.36651235   FALSE FALSE
#CheckSum                     102.055556   62.78935185   FALSE FALSE
#Subsystem                      6.449422    0.11574074   FALSE FALSE
#DllCharacteristics             4.010574    0.48225309   FALSE FALSE
#SizeOfStackReserve             4.379791    0.63657407   FALSE FALSE
#SizeOfStackCommit              5.419448    0.42438272   FALSE FALSE
#SizeOfHeapReserve             65.521127    0.84876543   FALSE  TRUE
#SizeOfHeapCommit              53.606742    0.27006173   FALSE  TRUE
#LoaderFlags                 5179.000000    0.11574074   FALSE  TRUE
#NumberOfRvaAndSizes          470.090909    0.07716049   FALSE  TRUE
#class                          1.072771    0.03858025   FALSE FALSE



####FILTERED ZERO VARIANCE PRED

nzv <- nearZeroVar(dataset)
filteredDescr_dataset <- dataset[,-nzv]

#dim(filteredDescr_dataset)
#[1] 5184   32


########DOES CORRELATION EXIST IN DATASET

#While there are some models that 
#thrive on correlated predictors (such as pls), 
#other models may benefit from reducing the level of 
#correlation between the predictors.



descrCor <-  cor(dataset)
summary(descrCor[upper.tri(descrCor)])


 #   Min.  1st Qu.   Median     Mean  3rd Qu.     Max.     NA's 
#-1.00000 -0.01246 -0.00119  0.01562  0.00795  1.00000      214 


######CENTER AND SCALE DATASET

preprocessParams <- preProcess(dataset[,-56], method=c("center", "scale"))
transformed <- predict(preprocessParams, dataset[,-56])


newdataset <- cbind(transformed,dataset[,56])


#########DESCRIPTIVE STATS

summary(dataset)



#> summary(dataset)
#    e_magic          e_cblp           e_cp             e_crlc    e_cparhdr    
# Min.   :23117   Min.   :    0   Min.   :  0.000   Min.   :0   Min.   :0.000  
# 1st Qu.:23117   1st Qu.:  144   1st Qu.:  3.000   1st Qu.:0   1st Qu.:4.000  
 Median :23117   Median :  144   Median :  3.000   Median :0   Median :4.000  
 Mean   :23117   Mean   :  146   Mean   :  2.939   Mean   :0   Mean   :3.972  
 3rd Qu.:23117   3rd Qu.:  144   3rd Qu.:  3.000   3rd Qu.:0   3rd Qu.:4.000  
 Max.   :23117   Max.   :37008   Max.   :144.000   Max.   :0   Max.   :4.000  
   e_minalloc         e_maxalloc         e_ss               e_sp        
 Min.   :   0.000   Min.   :    0   Min.   :    0.00   Min.   :    0.0  
 1st Qu.:   0.000   1st Qu.:65535   1st Qu.:    0.00   1st Qu.:  184.0  
 Median :   0.000   Median :65535   Median :    0.00   Median :  184.0  
 Mean   :   1.855   Mean   :65153   Mean   :   12.64   Mean   :  195.8  
 3rd Qu.:   0.000   3rd Qu.:65535   3rd Qu.:    0.00   3rd Qu.:  184.0  
 Max.   :4096.000   Max.   :65535   Max.   :65520.00   Max.   :65534.0  
     e_csum               e_ip               e_cs             e_lfarlc    
 Min.   :0.0000000   Min.   :    0.00   Min.   :    0.00   Min.   : 0.00  
 1st Qu.:0.0000000   1st Qu.:    0.00   1st Qu.:    0.00   1st Qu.:64.00  
 Median :0.0000000   Median :    0.00   Median :    0.00   Median :64.00  
 Mean   :0.0007716   Mean   :   10.52   Mean   :   23.47   Mean   :63.62  
 3rd Qu.:0.0000000   3rd Qu.:    0.00   3rd Qu.:    0.00   3rd Qu.:64.00  
 Max.   :2.0000000   Max.   :26621.00   Max.   :65520.00   Max.   :65.00  
     e_ovno       e_res            e_oemid           e_oeminfo       
 Min.   : 0.00   Mode:logical   Min.   :  0.0000   Min.   :0.000000  
 1st Qu.: 0.00   NA's:5184      1st Qu.:  0.0000   1st Qu.:0.000000  
 Median : 0.00                  Median :  0.0000   Median :0.000000  
 Mean   : 1.75                  Mean   :  0.1545   Mean   :0.004244  
 3rd Qu.: 0.00                  3rd Qu.:  0.0000   3rd Qu.:0.000000  
 Max.   :26.00                  Max.   :267.0000   Max.   :8.000000  
  e_res2           e_lfanew        Machine        NumberOfSections
 Mode:logical   Min.   : 12.0   Min.   :  332.0   Min.   : 1.000  
 NA's:5184      1st Qu.:208.0   1st Qu.:  332.0   1st Qu.: 4.000  
                Median :232.0   Median :  332.0   Median : 5.000  
                Mean   :223.3   Mean   :  404.3   Mean   : 4.666  
                3rd Qu.:248.0   3rd Qu.:  332.0   3rd Qu.: 5.000  
                Max.   :648.0   Max.   :34404.0   Max.   :34.000  
  CreationYear  PointerToSymbolTable NumberOfSymbols    SizeOfOptionalHeader
 Min.   :1970   Min.   :      0      Min.   :   0.000   Min.   :224         
 1st Qu.:2009   1st Qu.:      0      1st Qu.:   0.000   1st Qu.:224         
 Median :2010   Median :      0      Median :   0.000   Median :224         
 Mean   :2009   Mean   :   1017      Mean   :   6.318   Mean   :224         
 3rd Qu.:2012   3rd Qu.:      0      3rd Qu.:   0.000   3rd Qu.:224         
 Max.   :2102   Max.   :2846720      Max.   :6417.000   Max.   :240         
 Characteristics     Magic       MajorLinkerVersion MinorLinkerVersion
 Min.   :   34   Min.   :  0.0   Min.   :  0.000    Min.   :  0.000   
 1st Qu.:  258   1st Qu.:267.0   1st Qu.:  6.000    1st Qu.:  0.000   
 Median :  271   Median :267.0   Median :  8.000    Median :  0.000   
 Mean   : 4593   Mean   :266.4   Mean   :  7.576    Mean   :  5.385   
 3rd Qu.: 8450   3rd Qu.:267.0   3rd Qu.:  9.000    3rd Qu.: 10.000   
 Max.   :41358   Max.   :267.0   Max.   :255.000    Max.   :255.000   
   SizeOfCode        SizeOfInitializedData SizeOfUninitializedData
 Min.   :0.000e+00   Min.   :       0      Min.   :        0      
 1st Qu.:1.229e+04   1st Qu.:   12288      1st Qu.:        0      
 Median :3.738e+04   Median :   57344      Median :        0      
 Mean   :8.732e+05   Mean   :  276423      Mean   :   264429      
 3rd Qu.:1.357e+05   3rd Qu.:  102400      3rd Qu.:        0      
 Max.   :3.591e+09   Max.   :81166336      Max.   :522125312      
 AddressOfEntryPoint   BaseOfCode         BaseOfData         ImageBase        
 Min.   :       0    Min.   :       0   Min.   :       0   Min.   :0.000e+00  
 1st Qu.:    7104    1st Qu.:    4096   1st Qu.:   16384   1st Qu.:4.194e+06  
 Median :   19080    Median :    4096   Median :   45056   Median :4.194e+06  
 Mean   :  157961    Mean   :   46732   Mean   :  226987   Mean   :1.466e+08  
 3rd Qu.:   74962    3rd Qu.:    4096   3rd Qu.:  159744   3rd Qu.:2.684e+08  
 Max.   :42403872    Max.   :42225664   Max.   :42405888   Max.   :2.134e+09  
 SectionAlignment FileAlignment  MajorOperatingSystemVersion
 Min.   :   0     Min.   :   0   Min.   : 0.000             
 1st Qu.:4096     1st Qu.: 512   1st Qu.: 4.000             
 Median :4096     Median : 512   Median : 4.000             
 Mean   :4261     Mean   :1191   Mean   : 4.606             
 3rd Qu.:4096     3rd Qu.: 512   3rd Qu.: 5.000             
 Max.   :8192     Max.   :4096   Max.   :10.000             
 MinorOperatingSystemVersion MajorImageVersion MinorImageVersion 
 Min.   : 0.0000             Min.   :    0.0   Min.   :    0.00  
 1st Qu.: 0.0000             1st Qu.:    0.0   1st Qu.:    0.00  
 Median : 0.0000             Median :    0.0   Median :    0.00  
 Mean   : 0.4151             Mean   :  107.7   Mean   :   98.31  
 3rd Qu.: 1.0000             3rd Qu.:    4.0   3rd Qu.:    0.00  
 Max.   :23.0000             Max.   :40386.0   Max.   :51126.00  
 MajorSubsystemVersion MinorSubsystemVersion  SizeOfImage      
 Min.   :0.000         Min.   : 0.0000       Min.   :       0  
 1st Qu.:4.000         1st Qu.: 0.0000       1st Qu.:   81920  
 Median :4.000         Median : 0.0000       Median :  139264  
 Mean   :4.582         Mean   : 0.3555       Mean   :  558428  
 3rd Qu.:5.000         3rd Qu.: 0.0000       3rd Qu.:  348160  
 Max.   :6.000         Max.   :20.0000       Max.   :81252352  
 SizeOfHeaders        CheckSum           Subsystem      DllCharacteristics
 Min.   :      0   Min.   :0.000e+00   Min.   : 0.000   Min.   :    0     
 1st Qu.:   1024   1st Qu.:0.000e+00   1st Qu.: 2.000   1st Qu.:    0     
 Median :   1024   Median :7.800e+04   Median : 2.000   Median :    0     
 Mean   :   4061   Mean   :2.322e+06   Mean   : 2.139   Mean   : 9459     
 3rd Qu.:   1536   3rd Qu.:2.080e+05   3rd Qu.: 2.000   3rd Qu.:32768     
 Max.   :2314240   Max.   :4.295e+09   Max.   :16.000   Max.   :37184     
 SizeOfStackReserve SizeOfStackCommit SizeOfHeapReserve  SizeOfHeapCommit
 Min.   :       0   Min.   :      0   Min.   :       0   Min.   :     0  
 1st Qu.: 1048576   1st Qu.:   4096   1st Qu.: 1048576   1st Qu.:  4096  
 Median : 1048576   Median :   4096   Median : 1048576   Median :  4096  
 Mean   : 1989460   Mean   :  10389   Mean   : 2089821   Mean   :  5750  
 3rd Qu.: 1048576   3rd Qu.:   8192   3rd Qu.: 1048576   3rd Qu.:  4096  
 Max.   :33554432   Max.   :2097152   Max.   :33554432   Max.   :131072  
  LoaderFlags       NumberOfRvaAndSizes     class       
 Min.   :       0   Min.   : 0.00       Min.   :0.0000  
 1st Qu.:       0   1st Qu.:16.00       1st Qu.:0.0000  
 Median :       0   Median :16.00       Median :1.0000  
 Mean   :   42574   Mean   :15.96       Mean   :0.5176  
 3rd Qu.:       0   3rd Qu.:16.00       3rd Qu.:1.0000  
 Max.   :93827511   Max.   :16.00       Max.   :1.0000  



########PLOT

dataset[,'class']<-factor(dataset[,'class'])

featurePlot(x = dataset[,1:4], 
            y = dataset[,56],
            plot = "pairs")





#########TRAIN AND TEST SPLIT


trainIndex <- createDataPartition(dataset$class, p = .8, 
                                  list = FALSE, 
                                  times = 1)


malTrain <- dataset[ trainIndex,]
malTest  <- dataset[-trainIndex,]



########Parameter Tuning


malTrain[,'class']<-factor(malTrain[,'class'])


fitControl_1 <- trainControl(method = "boot", number = 3,
  repeats = 3, p = 0.75,
  search = "random", classProbs = FALSE,
  summaryFunction = defaultSummary,
  allowParallel = TRUE)


set.seed(825)

drops <- c("e_res","e_res2")
malTrain <- malTrain[ , !(names(malTrain) %in% drops)]
malTest <- malTest[ , !(names(malTest) %in% drops)]


gbmFit1 <- train(class ~ ., data = malTrain, 
                 method = "gbm", 
                 trControl = fitControl_1,
                 ## This last option is actually one
                 ## for gbm() that passes through
                 verbose = FALSE)


######DESCRIPTION OF MODEL - Gradient boosted trees

Stochastic Gradient Boosting 

4148 samples
  53 predictor
   2 classes: '0', '1' 

No pre-processing
Resampling: Bootstrapped (3 reps) 
Summary of sample sizes: 4148, 4148, 4148 
Resampling results across tuning parameters:

  shrinkage  interaction.depth  n.minobsinnode  n.trees  Accuracy   Kappa    
  0.1693168  2                  17              4878     0.9826689  0.9652564
  0.2187362  1                   7              1183     0.9729121  0.9457017
  0.5243721  1                  24               419     0.9716234  0.9431190

Accuracy was used to select the optimal model using  the largest value.
The final values used for the model were n.trees = 4878, interaction.depth =
 2, shrinkage = 0.1693168 and n.minobsinnode = 17. 


mal_pred_gbm1 <- predict.train(gbmFit1, newdata=malTest, models=gbmFit1$finalModel)

head(mal_pred_gbm1)

##########RESULTS

confusionMatrix(data = mal_pred_gbm1, reference = malTest$class)

Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 486  10
         1  12 528
                                         
               Accuracy : 0.9788         
                 95% CI : (0.968, 0.9866)
    No Information Rate : 0.5193         
    P-Value [Acc > NIR] : <2e-16         
                                         
                  Kappa : 0.9575         
 Mcnemar's Test P-Value : 0.8312         
                                         
            Sensitivity : 0.9759         
            Specificity : 0.9814         
         Pos Pred Value : 0.9798         
         Neg Pred Value : 0.9778         
             Prevalence : 0.4807         
         Detection Rate : 0.4691         
   Detection Prevalence : 0.4788         
      Balanced Accuracy : 0.9787         
                                         
       'Positive' Class : 0   

confusionMatrix(data = mal_pred_gbm1, reference = malTest$class, mode = "prec_recall")


Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 486  10
         1  12 528
                                         
               Accuracy : 0.9788         
                 95% CI : (0.968, 0.9866)
    No Information Rate : 0.5193         
    P-Value [Acc > NIR] : <2e-16         
                                         
                  Kappa : 0.9575         
 Mcnemar's Test P-Value : 0.8312         
                                         
              Precision : 0.9798         
                 Recall : 0.9759         
                     F1 : 0.9779         
             Prevalence : 0.4807         
         Detection Rate : 0.4691         
   Detection Prevalence : 0.4788         
      Balanced Accuracy : 0.9787         
                                         
       'Positive' Class : 0 




################SECOND PREDICTION ALGO



fitControl_2 <- trainControl(method = "boot", number = 3,
  repeats = 3, p = 0.75,
  search = "random", classProbs = FALSE,
  summaryFunction = defaultSummary,
  allowParallel = TRUE)


rfFit1 <- train(class ~ ., data = malTrain, 
                 method = "rf", 
                 trControl = fitControl_2,
                 ## This last option is actually one
                 ## for gbm() that passes through
                 verbose = FALSE)

########RANDOM FOREST

Random Forest 

4148 samples
  53 predictor
   2 classes: '0', '1' 

No pre-processing
Resampling: Bootstrapped (3 reps) 
Summary of sample sizes: 4148, 4148, 4148 
Resampling results across tuning parameters:

  mtry  Accuracy   Kappa    
  25    0.9822624  0.9644587
  46    0.9740278  0.9479666
  53    0.9735947  0.9470918

Accuracy was used to select the optimal model using  the largest value.
The final value used for the model was mtry = 25. 


#########PREDICTING

mal_pred_rf1 <- predict.train(rfFit1, newdata=malTest, models=rfFit1$finalModel)

#####ACCURACY


confusionMatrix(data = mal_pred_rf1, reference = malTest$class)

Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 484   9
         1  14 529
                                          
               Accuracy : 0.9778          
                 95% CI : (0.9669, 0.9859)
    No Information Rate : 0.5193          
    P-Value [Acc > NIR] : <2e-16          
                                          
                  Kappa : 0.9555          
 Mcnemar's Test P-Value : 0.4042          
                                          
            Sensitivity : 0.9719          
            Specificity : 0.9833          
         Pos Pred Value : 0.9817          
         Neg Pred Value : 0.9742          
             Prevalence : 0.4807          
         Detection Rate : 0.4672          
   Detection Prevalence : 0.4759          
      Balanced Accuracy : 0.9776          
                                          
       'Positive' Class : 0 

confusionMatrix(data = mal_pred_rf1, reference = malTest$class, mode = "prec_recall")


Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 484   9
         1  14 529
                                          
               Accuracy : 0.9778          
                 95% CI : (0.9669, 0.9859)
    No Information Rate : 0.5193          
    P-Value [Acc > NIR] : <2e-16          
                                          
                  Kappa : 0.9555          
 Mcnemar's Test P-Value : 0.4042          
                                          
              Precision : 0.9817          
                 Recall : 0.9719          
                     F1 : 0.9768          
             Prevalence : 0.4807          
         Detection Rate : 0.4672          
   Detection Prevalence : 0.4759          
      Balanced Accuracy : 0.9776          
                                          
       'Positive' Class : 0 



########THIRD CLASSIFIER - EXTREME LEARNING MACHINE


fitControl_3 <- trainControl(method = "boot", number = 3,
  repeats = 3, p = 0.75,
  search = "random", classProbs = FALSE,
  summaryFunction = defaultSummary,
  allowParallel = TRUE)


elmFit1 <- train(class ~ ., data = malTrain, 
                 method = "elm", 
                 trControl = fitControl_3,
                 ## This last option is actually one
                 ## for gbm() that passes through
                 verbose = FALSE)

Extreme Learning Machine 

4148 samples
  53 predictor
   2 classes: '0', '1' 

No pre-processing
Resampling: Bootstrapped (3 reps) 
Summary of sample sizes: 4148, 4148, 4148 
Resampling results across tuning parameters:

  nhid  actfun   Accuracy   Kappa     
   8    purelin  0.7585830  0.50820026
   9    purelin  0.7952993  0.58465640
  19    sin      0.5225257  0.04352806

Accuracy was used to select the optimal model using  the largest value.
The final values used for the model were nhid = 9 and actfun = purelin.


mal_pred_elm1 <- predict.train(elmFit1, newdata=malTest, models=elmFit1$finalModel)



 confusionMatrix(data = mal_pred_elm1, reference = malTest$class)
Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 255  25
         1 243 513
                                          
               Accuracy : 0.7413          
                 95% CI : (0.7135, 0.7677)
    No Information Rate : 0.5193          
    P-Value [Acc > NIR] : < 2.2e-16       
                                          
                  Kappa : 0.4733          
 Mcnemar's Test P-Value : < 2.2e-16       
                                          
            Sensitivity : 0.5120          
            Specificity : 0.9535          
         Pos Pred Value : 0.9107          
         Neg Pred Value : 0.6786          
             Prevalence : 0.4807          
         Detection Rate : 0.2461          
   Detection Prevalence : 0.2703          
      Balanced Accuracy : 0.7328          
                                          
       'Positive' Class : 0               
                                          
> confusionMatrix(data = mal_pred_elm1, reference = malTest$class, mode = "prec_recall")
Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 255  25
         1 243 513
                                          
               Accuracy : 0.7413          
                 95% CI : (0.7135, 0.7677)
    No Information Rate : 0.5193          
    P-Value [Acc > NIR] : < 2.2e-16       
                                          
                  Kappa : 0.4733          
 Mcnemar's Test P-Value : < 2.2e-16       
                                          
              Precision : 0.9107          
                 Recall : 0.5120          
                     F1 : 0.6555          
             Prevalence : 0.4807          
         Detection Rate : 0.2461          
   Detection Prevalence : 0.2703          
      Balanced Accuracy : 0.7328          
                                          
       'Positive' Class : 0 







########### EXTREME GRADIENT BOOSTED TREES

fitControl_4 <- trainControl(method = "boot", number = 3,
  repeats = 3, p = 0.75,
  search = "random", classProbs = FALSE,
  summaryFunction = defaultSummary,
  allowParallel = TRUE)


xgbFit1 <- train(class ~ ., data = malTrain, 
                 method = "xgbTree", 
                 trControl = fitControl_4,
                 ## This last option is actually one
                 ## for gbm() that passes through
                 verbose = FALSE)

eXtreme Gradient Boosting 

4148 samples
  53 predictor
   2 classes: '0', '1' 

No pre-processing
Resampling: Bootstrapped (3 reps) 
Summary of sample sizes: 4148, 4148, 4148 
Resampling results across tuning parameters:

  eta        max_depth  gamma      colsample_bytree  min_child_weight
  0.1318602  8          2.3959779  0.6765862         20              
  0.2063794  8          0.4577827  0.4306649          7              
  0.5064030  2          7.4026320  0.6904084         10              
  subsample  nrounds  Accuracy   Kappa    
  0.6783140  261      0.9686148  0.9370872
  0.7969105  131      0.9798844  0.9596662
  0.4269941  969      0.9657254  0.9312891

Accuracy was used to select the optimal model using  the largest value.
The final values used for the model were nrounds = 131, max_depth = 8, eta
 = 0.2063794, gamma = 0.4577827, colsample_bytree = 0.4306649,
 min_child_weight = 7 and subsample = 0.7969105. 


mal_pred_xgb1 <- predict.train(xgbFit1, newdata=malTest, models=xgbFit1$finalModel)


confusionMatrix(data = mal_pred_xgb1, reference = malTest$class)
Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 487   7
         1  11 531
                                          
               Accuracy : 0.9826          
                 95% CI : (0.9727, 0.9897)
    No Information Rate : 0.5193          
    P-Value [Acc > NIR] : <2e-16          
                                          
                  Kappa : 0.9652          
 Mcnemar's Test P-Value : 0.4795          
                                          
            Sensitivity : 0.9779          
            Specificity : 0.9870          
         Pos Pred Value : 0.9858          
         Neg Pred Value : 0.9797          
             Prevalence : 0.4807          
         Detection Rate : 0.4701          
   Detection Prevalence : 0.4768          
      Balanced Accuracy : 0.9825          
                                          
       'Positive' Class : 0               
                                          
>  confusionMatrix(data = mal_pred_xgb1, reference = malTest$class, mode = "prec_recall")
Confusion Matrix and Statistics

          Reference
Prediction   0   1
         0 487   7
         1  11 531
                                          
               Accuracy : 0.9826          
                 95% CI : (0.9727, 0.9897)
    No Information Rate : 0.5193          
    P-Value [Acc > NIR] : <2e-16          
                                          
                  Kappa : 0.9652          
 Mcnemar's Test P-Value : 0.4795          
                                          
              Precision : 0.9858          
                 Recall : 0.9779          
                     F1 : 0.9819          
             Prevalence : 0.4807          
         Detection Rate : 0.4701          
   Detection Prevalence : 0.4768          
      Balanced Accuracy : 0.9825          
                                          
       'Positive' Class : 0 




####### COMPARE MODELS

resamps <- resamples(list(GBM = gbmFit1,
                          RF = rfFit1,
                          ELM = elmFit1, XGB = xgbFit1))


summary(resamps)

Models: GBM, RF, ELM, XGB 
Number of resamples: 3 

Accuracy 
      Min. 1st Qu. Median   Mean 3rd Qu.   Max. NA's
GBM 0.9786  0.9813 0.9839 0.9827  0.9847 0.9855    0
RF  0.9817  0.9818 0.9820 0.9823  0.9825 0.9831    0
ELM 0.7274  0.7558 0.7841 0.7953  0.8293 0.8744    0
XGB 0.9783  0.9792 0.9801 0.9799  0.9807 0.9813    0

Kappa 
      Min. 1st Qu. Median   Mean 3rd Qu.   Max. NA's
GBM 0.9572  0.9625 0.9678 0.9653  0.9693 0.9707    0
RF  0.9634  0.9636 0.9639 0.9645  0.9650 0.9661    0
ELM 0.4493  0.5033 0.5574 0.5847  0.6523 0.7473    0
XGB 0.9564  0.9582 0.9600 0.9597  0.9613 0.9625    0


trellis.par.set(theme1)
bwplot(resamps, layout = c(3, 1))

  

##########COMPUTE VARIABLE IMPORTANCE

gbmImp <- varImp(gbmFit1, scale = FALSE)

gbm variable importance

  only 20 most important variables shown (out of 53)

                            Overall
ImageBase                   295.290
MajorSubsystemVersion       284.698
CheckSum                    265.179
Characteristics             241.582
Subsystem                    99.034
DllCharacteristics           93.186
AddressOfEntryPoint          68.733
e_lfanew                     35.874
SizeOfImage                  33.647
CreationYear                 33.181
MajorImageVersion            30.578
SizeOfStackReserve           29.389
FileAlignment                20.947
MajorLinkerVersion           20.863
NumberOfSections             20.028
MajorOperatingSystemVersion  16.506
SizeOfUninitializedData      13.310
SizeOfInitializedData        10.493
SizeOfStackCommit             8.457
BaseOfData                    5.684

elmImp <- varImp(elmFit1, scale = FALSE)

ROC curve variable importance

  only 20 most important variables shown (out of 53)

                        Importance
SizeOfStackReserve          0.7252
SizeOfHeapReserve           0.5900
SizeOfUninitializedData     0.5771
SizeOfHeapCommit            0.5746
e_minalloc                  0.5471
SizeOfImage                 0.5458
e_ovno                      0.5444
SizeOfHeaders               0.5369
MinorLinkerVersion          0.5366
SizeOfInitializedData       0.5337
NumberOfSections            0.5203
SizeOfStackCommit           0.5119
BaseOfCode                  0.5060
Magic                       0.5025
NumberOfRvaAndSizes         0.5023
LoaderFlags                 0.5012
e_ip                        0.5007
e_oemid                     0.5007
e_csum                      0.5007
e_oeminfo                   0.5007


xgbTree variable importance

  only 20 most important variables shown (out of 31)

                            Overall
CheckSum                    0.19847
Characteristics             0.09445
MajorImageVersion           0.08956
ImageBase                   0.07981
e_lfanew                    0.06295
Subsystem                   0.05587
AddressOfEntryPoint         0.04607
NumberOfSections            0.03763
SizeOfStackReserve          0.03568
DllCharacteristics          0.03529
FileAlignment               0.03034
SizeOfImage                 0.02903
CreationYear                0.02819
SizeOfHeaders               0.02451
BaseOfData                  0.02405
SizeOfInitializedData       0.01881
MajorSubsystemVersion       0.01695
MajorOperatingSystemVersion 0.01561
MinorLinkerVersion          0.01467
SizeOfCode                  0.01166
> rfImp
rf variable importance

  only 20 most important variables shown (out of 53)

                            Overall
ImageBase                    393.63
CheckSum                     276.37
Characteristics              240.45
SizeOfStackReserve           163.69
Subsystem                    161.00
MajorSubsystemVersion        152.26
DllCharacteristics            98.00
AddressOfEntryPoint           68.46
MajorImageVersion             59.53
MajorOperatingSystemVersion   53.21
e_lfanew                      44.48
SizeOfStackCommit             43.83
CreationYear                  34.07
MajorLinkerVersion            29.72
SizeOfImage                   29.35
SectionAlignment              24.79
SizeOfCode                    24.16
SizeOfInitializedData         22.20
MinorSubsystemVersion         22.15
BaseOfData                    19.98



